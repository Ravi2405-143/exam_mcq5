<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam in Progress</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="centered-wrapper">
        <div class="sticky-header">
            <div class="timer-box">
                <div style="display: flex; flex-direction: column;">
                    <span class="stat-label">Subject</span>
                    <span style="font-weight: 700; font-size: 0.9rem; color: var(--primary);">{{ subject }}</span>
                </div>
                <div id="timer" class="timer">00:00</div>
            </div>
            <div class="progress-container">
                <div id="exam-progress" class="progress-bar"></div>
            </div>
        </div>

        <form id="quiz-form" method="POST" action="/submit">
            <div id="flag-container"></div>
            {% for q in questions %}
            <div class="question-card" id="card_{{ q.id }}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <span class="question-num">Question {{ loop.index }} of {{ questions|length }}</span>
                    <button type="button" class="flag-btn" onclick="toggleFlag('{{ q.id }}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="3">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                            <line x1="4" y1="22" x2="4" y2="15"></line>
                        </svg>
                        Flag for Review
                    </button>
                </div>
                <input type="hidden" name="question_ids" value="{{ q.id }}">
                <div class="question-text">{{ q.question }}</div>

                <div class="option-container">
                    {% for letter, text in q.options %}
                    <label class="option-item">
                        <input type="radio" name="q_{{ q.id }}" value="{{ letter }}" onchange="updateProgress()">
                        <div class="option-label">
                            <span class="option-letter">{{ letter }}</span>
                            <span>{{ text }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            <button type="submit" class="btn" style="margin-bottom: 5rem;">
                Complete Assessment
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </button>
        </form>
    </div>

    <script>
        const durationMinutes = {{ duration }};
        const totalQuestions = {{ questions| length }};
        let timeRemaining = durationMinutes * 60;
        const timerDisplay = document.getElementById('timer');
        const progressBar = document.getElementById('exam-progress');

        // Timer Logic
        const timer = setInterval(() => {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeRemaining <= 30) {
                timerDisplay.style.color = 'var(--error)';
                timerDisplay.style.animation = 'pulse 1s infinite';
            }

            if (timeRemaining <= 0) {
                clearInterval(timer);
                document.getElementById('quiz-form').submit();
            }
            timeRemaining--;
        }, 1000);

        // Progress Tracking
        function updateProgress() {
            const answered = document.querySelectorAll('input[type="radio"]:checked').length;
            const percentage = (answered / totalQuestions) * 100;
            progressBar.style.width = percentage + '%';
        }

        // Flagging Logic
        const flagged = new Set();
        function toggleFlag(qid) {
            const btn = document.querySelector(`#card_${qid} .flag-btn`);
            const container = document.getElementById('flag-container');

            if (flagged.has(qid)) {
                flagged.delete(qid);
                btn.classList.remove('active');
                document.getElementById(`flag_input_${qid}`).remove();
            } else {
                flagged.add(qid);
                btn.classList.add('active');
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'flagged_ids';
                input.value = qid;
                input.id = `flag_input_${qid}`;
                container.appendChild(input);
            }
        }

        // Prevent accidental navigation
        window.onbeforeunload = function () {
            return "Exam progress will be lost. Are you sure?";
        };

        document.getElementById('quiz-form').onsubmit = function () {
            window.onbeforeunload = null;
        };
    </script>

    <style>
        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</body>

</html>